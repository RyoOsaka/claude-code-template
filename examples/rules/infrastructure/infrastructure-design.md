---
paths:
  - "infrastructure/**"
  - "terraform/**"
---

# インフラ設計ガイドライン

クラウドインフラ設計の共通原則。AWS / GCP 固有の実現方法は各クラウドのガイドラインを参照。

## 設計の優先順位

判断に迷ったときは以下の順序で優先する:

1. **セキュリティ** - 侵害されたら取り返しがつかない
2. **可用性** - 落ちたらビジネスが止まる
3. **運用性** - 運用できなければ維持できない
4. **コスト** - 無駄な支出は避ける
5. **パフォーマンス** - 必要十分であればよい

---

## 可用性・冗長性

### 基本原則

- **単一障害点（SPOF）を作らない** - すべてのコンポーネントは冗長化する
- **障害ドメインを分散する** - AZ / リージョン をまたぐ
- **グレースフルデグラデーション** - 一部障害時も全体停止せず縮退運転する（例: レプリカ 1 台停止でも読み取り継続）

### 環境別の可用性目標

| 環境 | 可用性目標 | 構成 |
|------|-----------|------|
| 開発 | 95%（月36時間停止可） | シングル AZ、最小構成 |
| ステージング | 99%（月7時間停止可） | マルチ AZ、本番同等構成 |
| 本番 | 99.9%（月43分停止可） | マルチ AZ、冗長化必須 |
| ミッションクリティカル | 99.99%（月4分停止可） | マルチリージョン |

### 冗長化パターン

```
レイヤー別の冗長化:

[ロードバランサー] - マネージドサービス利用（自動冗長化）
        ↓
[アプリケーション] - 複数 AZ に分散配置、Auto Scaling
        ↓
[データベース]     - マルチ AZ レプリケーション、自動フェイルオーバー
        ↓
[ストレージ]       - マネージドサービス利用（自動冗長化）
```

### ヘルスチェック

- アプリケーションレベルのヘルスチェックを実装する（TCP ではなく HTTP）
- ヘルスチェックエンドポイントは依存サービスの状態も確認する
- 異常なインスタンスは自動的にトラフィックから除外する

---

## ネットワーク設計

### 基本原則

- **パブリック/プライベートを明確に分離する**
- **最小限のインターネット露出** - 必要なものだけパブリックに
- **トラフィックを集約する** - 直接通信を避け、LB や API Gateway 経由にする（監視・制御のため）

### サブネット設計

| サブネット種別 | 配置するもの | インターネットアクセス |
|---------------|-------------|---------------------|
| Public | LB、NAT Gateway、踏み台 | 双方向 |
| Private | アプリケーション、バッチ | アウトバウンドのみ（NAT 経由） |
| Isolated | DB、キャッシュ、内部サービス | なし |

### CIDR 設計

- VPC は将来の拡張を見越して大きめに確保する（/16 推奨）
- サブネットは AZ ごとに均等に分割する
- 他 VPC やオンプレミスとのピアリングを考慮し、CIDR が重複しないようにする
- プライベート IP 範囲（RFC 1918）を使用する
  - `10.0.0.0/8`
  - `172.16.0.0/12`
  - `192.168.0.0/16`

### CIDR 設計例

```
本番 VPC:     10.0.0.0/16
├── AZ-a:     10.0.0.0/18
│   ├── Public:    10.0.0.0/20
│   ├── Private:   10.0.16.0/20
│   └── Isolated:  10.0.32.0/20
├── AZ-b:     10.0.64.0/18
└── AZ-c:     10.0.128.0/18

開発 VPC:     10.1.0.0/16
ステージング: 10.2.0.0/16
```

---

## セキュリティ設計

### 基本原則

- **多層防御（Defense in Depth）** - 単一の防御に依存しない
- **最小権限の原則** - 必要最小限の権限のみ付与する
- **ゼロトラスト** - ネットワーク境界を信頼しない、常に検証する
- **シークレットをコードに書かない** - シークレット管理サービスを使う

### アクセス制御の層

```
1. ネットワーク層
   └── ファイアウォール / Security Group / ACL

2. アイデンティティ層
   └── IAM ロール / サービスアカウント / 認証

3. アプリケーション層
   └── 認証・認可、入力検証

4. データ層
   └── 暗号化、アクセスログ
```

### ネットワークセキュリティ

- デフォルト deny、必要なトラフィックのみ許可
- ソース IP を可能な限り限定する（0.0.0.0/0 を避ける）
- 管理用アクセスは VPN / 踏み台経由に限定する
- 本番環境への直接 SSH / RDP は禁止（セッションマネージャー等を使用）

### IAM / アイデンティティ

- 人間にはロールベースアクセス（RBAC）を適用する
- サービス間通信はサービスアカウント / IAM ロールを使用する
- アクセスキーの発行は最小限に、定期ローテーション必須
- MFA を必須にする（特に本番環境）
- 一時的な認証情報を優先する（長期クレデンシャルを避ける）

### データ保護

- 保存データ（at rest）は暗号化必須
- 転送データ（in transit）は TLS 必須
- 暗号化キーはマネージドサービスで管理する
- 機密データにはカスタマーマネージドキー（CMK）を検討する

### シークレット管理

- シークレットは専用サービスで管理する（Secrets Manager / Secret Manager）
- 環境変数での受け渡しは許容するが、コード・設定ファイルへの直書きは禁止
- シークレットは定期的にローテーションする
- アクセスログを有効にして監査可能にする

---

## 監視・ログ・アラート

### 基本原則

- **観測可能性（Observability）を確保する** - メトリクス、ログ、トレースの3本柱
- **異常を検知できる状態を維持する** - 監視なきシステムは運用できない
- **アラート疲れを防ぐ** - Critical/Warning は人間の対応が必要なものに限定する

### 監視の3本柱

| 種類 | 目的 | 例 |
|------|------|-----|
| メトリクス | リソース状態の定量化 | CPU、メモリ、リクエスト数、レイテンシ |
| ログ | イベントの記録 | アプリログ、アクセスログ、エラーログ |
| トレース | リクエストの追跡 | 分散トレーシング（サービス間の呼び出し） |

### メトリクス設計

必須メトリクス（RED メソッド）:
- **Rate** - リクエスト数 / 秒
- **Errors** - エラー率（%）
- **Duration** - レイテンシ（p50, p95, p99）

リソースメトリクス:
- CPU 使用率
- メモリ使用率
- ディスク使用率
- ネットワーク I/O

### ログ設計

- 構造化ログ（JSON）を使用する
- ログレベルを適切に使い分ける（ERROR / WARN / INFO / DEBUG）
- リクエスト ID を付与してトレース可能にする
- 機密情報をログに出力しない（パスワード、トークン、個人情報）
- 保持期間を設定する（コストと監査要件のバランス）

### アラート設計

アラートレベル:
| レベル | 対応 | 例 |
|--------|------|-----|
| Critical | 即時対応（24/7） | サービスダウン、データ損失の恐れ |
| Warning | 営業時間内対応 | リソース枯渇の予兆、エラー率上昇 |
| Info | 確認のみ | デプロイ完了、スケールイベント |

アラート設計のポイント:
- アクションにつながらないアラートは作らない
- 閾値は実測値に基づいて設定する（推測しない）
- フラッピング防止のため、持続時間条件を設ける

---

## バックアップ・DR（災害復旧）

### 基本原則

- **バックアップは復元テストして初めて意味がある**
- **RTO / RPO を明確に定義する**
- **DR 訓練を定期的に実施する**

### 用語

| 用語 | 意味 |
|------|------|
| RTO（目標復旧時間） | 障害発生から復旧までの許容時間 |
| RPO（目標復旧時点） | 許容できるデータ損失の時間幅 |

### バックアップ戦略

| データ種別 | バックアップ頻度 | 保持期間 | 例 |
|-----------|----------------|---------|-----|
| データベース | 日次 + トランザクションログ | 30日 | RDS スナップショット |
| ファイルストレージ | 日次 or リアルタイム | 用途による | S3 バージョニング |
| 設定・コード | Git 管理 | 永続 | Terraform state |

### DR パターン

| パターン | RTO | RPO | コスト | 構成 |
|---------|-----|-----|--------|------|
| バックアップ & リストア | 時間単位 | 日次 | 低 | バックアップのみ保持 |
| パイロットライト | 分〜時間 | 分 | 中 | 最小構成を待機 |
| ウォームスタンバイ | 分 | 秒〜分 | 高 | 縮小構成で稼働 |
| マルチリージョンアクティブ | 秒 | ほぼゼロ | 最高 | 複数リージョンで同時稼働 |

### 復旧テスト

- 最低でも年 1 回、復旧手順をテストする
- 復旧手順書を最新に保つ
- 復旧にかかる実時間を計測し、RTO を満たせるか確認する

---

## スケーリング

### 基本原則

- **スケールアウト優先** - 垂直より水平スケーリング
- **ステートレス設計** - アプリケーションに状態を持たせない
- **ボトルネックを特定してから最適化する** - 推測で対応しない

### スケーリング方式

| 方式 | 説明 | ユースケース |
|------|------|-------------|
| 垂直（スケールアップ） | インスタンスサイズを大きくする | DB など水平が難しいもの |
| 水平（スケールアウト） | インスタンス数を増やす | ステートレスなアプリ |

### Auto Scaling 設計

- スケールアウトは積極的に（早めに追加）
- スケールインは慎重に（クールダウン期間を設ける）
- 最小/最大インスタンス数を設定してコストを制御する
- 複数のメトリクスを組み合わせる（CPU + リクエスト数など）

### ステートレス設計のポイント

- セッション情報は外部ストア（Redis 等）に保存する
- ファイルアップロードはオブジェクトストレージへ直接
- ローカルディスクを一時領域以外に使わない

---

## コスト最適化

### 基本原則

- **使った分だけ払う** - 未使用リソースを放置しない
- **適切なサイズを選ぶ** - オーバープロビジョニングを避ける
- **コミットメントを活用する** - 予測可能なワークロードは割引を利用

### コスト削減の優先順位

1. **不要リソースの削除** - 最も効果的（使ってないものに払わない）
2. **適正サイズへの変更** - 実測値に基づいてダウンサイズ
3. **割引オプションの活用** - リザーブド、Savings Plans、確約利用割引
4. **アーキテクチャの見直し** - サーバーレス化、マネージドサービス活用

### 環境別のコスト戦略

| 環境 | 戦略 |
|------|------|
| 開発 | 営業時間外は停止、スポット/プリエンプティブル活用 |
| ステージング | 必要時のみ起動、最小構成 |
| 本番 | 安定稼働優先、リザーブド/確約利用割引 |

### コスト可視化

- タグ / ラベルでコストを分類する（環境、プロジェクト、チーム）
- 月次でコストレビューを実施する
- 予算アラートを設定する
- 異常検知を有効にする（急激なコスト増加を検知）

---

## 環境分離

### 基本原則

- **本番環境を保護する** - 開発/検証の影響を受けない
- **環境間の構成差異を最小化する** - 同じコードで動く状態を保つ
- **環境ごとにアカウント/プロジェクトを分離する**（推奨）

### 分離レベル

| レベル | 分離方法 | メリット | デメリット |
|--------|---------|---------|-----------|
| 論理分離 | 同一アカウント内でタグ/命名で分離 | シンプル、低コスト | 権限管理が複雑、事故リスク |
| アカウント分離 | 環境ごとに別アカウント | 完全分離、請求分離 | 管理が複雑、クロスアカウント設定が必要 |

**推奨: 本番は必ず別アカウント/プロジェクトにする**

### 環境間のデータ

- 本番データを開発/ステージングに持ち込まない
- どうしても必要な場合はマスキング/匿名化する
- 本番への直接アクセスは原則禁止（監査ログ必須）

---

## 設計レビューチェックリスト

新規インフラ構築時に確認する項目:

### 可用性

- [ ] 単一障害点がないか
- [ ] マルチ AZ 構成になっているか（本番）
- [ ] ヘルスチェックが設定されているか
- [ ] Auto Scaling が設定されているか

### セキュリティ

- [ ] パブリック/プライベートが適切に分離されているか
- [ ] Security Group / ファイアウォールが最小権限か
- [ ] 暗号化が有効か（保存・転送）
- [ ] シークレットがコードに含まれていないか
- [ ] IAM が最小権限か

### 運用

- [ ] 監視/アラートが設定されているか
- [ ] ログが適切に収集されているか
- [ ] バックアップが設定されているか
- [ ] 復旧手順が文書化されているか

### コスト

- [ ] 適切なインスタンスサイズか
- [ ] 不要なリソースがないか
- [ ] タグ/ラベルが付与されているか
- [ ] 開発環境の自動停止が設定されているか

---

## NEVER

- 本番環境に単一 AZ 構成を採用しない
- 0.0.0.0/0 からの SSH / RDP を許可しない
- シークレットをコードや設定ファイルに書かない
- バックアップなしで本番 DB を運用しない
- 監視/アラートなしで本番運用しない
- 復旧テストなしで DR 計画を信頼しない

## YOU MUST

- 本番環境はマルチ AZ 構成にする
- 全データを暗号化する（保存時・転送時）
- 全リソースにタグ/ラベルを付与する
- バックアップと復旧手順を用意する
- 監視とアラートを設定する
- 設計レビューチェックリストを実施する
