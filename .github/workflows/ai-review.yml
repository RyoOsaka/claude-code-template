name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files_ignore: |
            *.lock
            *.min.js
            *.min.css
            dist/**
            build/**
            node_modules/**
            *.generated.*

      - name: Run AI Review
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          node .github/ai-review/review.mjs

      - name: Post review comment
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            if (!fs.existsSync('.github/ai-review/result.md')) {
              console.log('No review result found');
              return;
            }

            const body = fs.readFileSync('.github/ai-review/result.md', 'utf8');

            // ç©ºã®çµæœã¯ã‚¹ã‚­ãƒƒãƒ—
            if (!body.trim()) {
              console.log('No issues found');
              return;
            }

            // æ—¢å­˜ã®ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## ğŸ¤– AI Code Review')
            );

            const commentBody = `## ğŸ¤– AI Code Review

            ${body}

            ---
            <sub>ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã¯ \`.github/ai-review/config.yml\` ã§å¤‰æ›´ã§ãã¾ã™ã€‚</sub>`;

            if (botComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }
